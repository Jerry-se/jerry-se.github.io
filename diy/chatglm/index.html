<!DOCTYPE html>
<html lang="en" data-bs-theme="light">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        <meta name="author" content="Jerry">
        <link rel="canonical" href="https://jerry-se.github.io/diy/chatglm/">
        <link rel="shortcut icon" href="../../img/favicon.ico">
        <title>ChatGLM - Jerry's blog</title>
        <link href="../../css/bootstrap.min.css" rel="stylesheet">
        <link href="../../css/fontawesome.min.css" rel="stylesheet">
        <link href="../../css/brands.min.css" rel="stylesheet">
        <link href="../../css/solid.min.css" rel="stylesheet">
        <link href="../../css/v4-font-face.min.css" rel="stylesheet">
        <link href="../../css/base.css" rel="stylesheet">
        <link id="hljs-light" rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" >
        <link id="hljs-dark" rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github-dark.min.css" disabled>
        <link href="../../css/extra.css" rel="stylesheet">
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/yaml.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/django.min.js"></script>
        <script>hljs.highlightAll();</script>
        <script async src="https://www.googletagmanager.com/gtag/js?id=G-274394082"></script>
        <script>
          window.dataLayer = window.dataLayer || [];
          function gtag(){dataLayer.push(arguments);}
          gtag('js', new Date());

          gtag('config', "G-274394082");
        </script> 
    </head>

    <body>
        <div class="navbar fixed-top navbar-expand-lg navbar-dark bg-primary">
            <div class="container">
                <a class="navbar-brand" href="../..">Jerry's blog</a>
                <!-- Expander button -->
                <button type="button" class="navbar-toggler" data-bs-toggle="collapse" data-bs-target="#navbar-collapse" aria-controls="navbar-collapse" aria-expanded="false" aria-label="Toggle navigation">
                    <span class="navbar-toggler-icon"></span>
                </button>

                <!-- Expanded navigation -->
                <div id="navbar-collapse" class="navbar-collapse collapse">
                        <!-- Main navigation -->
                        <ul class="nav navbar-nav">
                            <li class="nav-item">
                                <a href="../.." class="nav-link">Home</a>
                            </li>
                            <li class="nav-item">
                                <a href="../../markdown/" class="nav-link">Markdown</a>
                            </li>
                            <li class="nav-item dropdown">
                                <a href="#" class="nav-link dropdown-toggle" role="button" data-bs-toggle="dropdown"  aria-expanded="false">C/C++</a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../../cplusplus/lambda/" class="dropdown-item">Lambda</a>
</li>
                                    
<li>
    <a href="../../cplusplus/questions/" class="dropdown-item">Questions</a>
</li>
                                    
<li>
    <a href="../../cplusplus/bit_xor/" class="dropdown-item">Bit Xor</a>
</li>
                                </ul>
                            </li>
                            <li class="nav-item dropdown">
                                <a href="#" class="nav-link dropdown-toggle" role="button" data-bs-toggle="dropdown"  aria-expanded="false">Go</a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../../go/go/" class="dropdown-item">Go tutorial</a>
</li>
                                    
<li>
    <a href="../../go/install/" class="dropdown-item">Install</a>
</li>
                                    
<li>
    <a href="../../go/getting_started/" class="dropdown-item">Getting started</a>
</li>
                                    
<li>
    <a href="../../go/create_module/" class="dropdown-item">Create module</a>
</li>
                                    
<li>
    <a href="../../go/workspaces/" class="dropdown-item">Workspaces</a>
</li>
                                    
<li>
    <a href="../../go/web_service_gin/" class="dropdown-item">Web service gin</a>
</li>
                                    
<li>
    <a href="../../go/generics/" class="dropdown-item">Generics</a>
</li>
                                    
<li>
    <a href="../../go/writing_web_app/" class="dropdown-item">Writing Web app</a>
</li>
                                </ul>
                            </li>
                            <li class="nav-item dropdown">
                                <a href="#" class="nav-link dropdown-toggle" role="button" data-bs-toggle="dropdown"  aria-expanded="false">Tool</a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../../git/git/" class="dropdown-item">Git</a>
</li>
                                    
<li>
    <a href="../../git/git_lfs/" class="dropdown-item">Git LFS</a>
</li>
                                    
<li>
    <a href="../../git/gitea/" class="dropdown-item">Gitea</a>
</li>
                                    
<li>
    <a href="../../tool/frp/" class="dropdown-item">Frp</a>
</li>
                                    
<li>
    <a href="../../tool/v2ray/" class="dropdown-item">V2Ray</a>
</li>
                                    
<li>
    <a href="../../tool/activation_keys/" class="dropdown-item">Activation</a>
</li>
                                </ul>
                            </li>
                            <li class="nav-item dropdown">
                                <a href="#" class="nav-link dropdown-toggle" role="button" data-bs-toggle="dropdown"  aria-expanded="false">Python</a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../../python/build_blogs_with_pelican/" class="dropdown-item">Pelican</a>
</li>
                                    
<li>
    <a href="../../python/mkdocs/" class="dropdown-item">MkDocs</a>
</li>
                                </ul>
                            </li>
                            <li class="nav-item dropdown">
                                <a href="#" class="nav-link dropdown-toggle" role="button" data-bs-toggle="dropdown"  aria-expanded="false">Linux å¼€å‘</a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../../linux_development/docker/" class="dropdown-item">docker</a>
</li>
                                    
<li>
    <a href="../../linux_development/coredump/" class="dropdown-item">coredump</a>
</li>
                                    
<li>
    <a href="../../linux_development/ipmi/" class="dropdown-item">ipmi</a>
</li>
                                    
<li>
    <a href="../../linux_development/make_deb_package/" class="dropdown-item">åˆ¶ä½œ deb å®‰è£…åŒ…</a>
</li>
                                    
<li>
    <a href="../../linux_development/samba/" class="dropdown-item">Samba</a>
</li>
                                    
<li>
    <a href="../../linux_development/scsi/" class="dropdown-item">SCSI</a>
</li>
                                </ul>
                            </li>
                            <li class="nav-item dropdown">
                                <a href="#" class="nav-link dropdown-toggle" role="button" data-bs-toggle="dropdown"  aria-expanded="false">Windows å¼€å‘</a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../../windows_development/character_encoding/" class="dropdown-item">å­—ç¬¦ç¼–ç </a>
</li>
                                    
<li>
    <a href="../../windows_development/autostart/" class="dropdown-item">å¼€æœºå¯åŠ¨</a>
</li>
                                    
<li>
    <a href="../../windows_development/automatic_power_up/" class="dropdown-item">è‡ªåŠ¨å¼€æœº</a>
</li>
                                </ul>
                            </li>
                            <li class="nav-item">
                                <a href="../../sitemap/" class="nav-link">Index</a>
                            </li>
                        </ul>

                    <ul class="nav navbar-nav ms-md-auto">
                        <li class="nav-item">
                            <a href="#" class="nav-link" data-bs-toggle="modal" data-bs-target="#mkdocs_search_modal">
                                <i class="fa fa-search"></i> Search
                            </a>
                        </li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="container">
            <div class="row">
                    <div class="col-md-3"><div class="navbar-expand-md bs-sidebar hidden-print affix" role="complementary">
    <div class="navbar-header">
        <button type="button" class="navbar-toggler collapsed" data-bs-toggle="collapse" data-bs-target="#toc-collapse" title="Table of Contents">
            <span class="fa fa-angle-down"></span>
        </button>
    </div>

    
    <div id="toc-collapse" class="navbar-collapse collapse card bg-body-tertiary">
        <ul class="nav flex-column">
            
            <li class="nav-item" data-bs-level="1"><a href="#chatglm" class="nav-link">ChatGLM</a>
              <ul class="nav flex-column">
            <li class="nav-item" data-bs-level="2"><a href="#introduction" class="nav-link">æ¦‚è¿°</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#python" class="nav-link">Python</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#cuda" class="nav-link">Cuda</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#test" class="nav-link">æµ‹è¯•</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#package" class="nav-link">æ‰“åŒ…</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#references" class="nav-link">å‚è€ƒèµ„æ–™</a>
              <ul class="nav flex-column">
              </ul>
            </li>
              </ul>
            </li>
        </ul>
    </div>
</div></div>
                    <div class="col-md-9" role="main">

<h1 id="chatglm">ChatGLM<a class="headerlink" href="#chatglm" title="Permanent link">ïƒ</a></h1>
<p>ChatGLM-6B æ˜¯ä¸€ä¸ªå¼€æºçš„ã€æ”¯æŒä¸­è‹±åŒè¯­çš„å¯¹è¯è¯­è¨€æ¨¡å‹ï¼ŒåŸºäº <a href="https://github.com/THUDM/GLM">General Language Model (GLM)</a> æ¶æ„ï¼Œå…·æœ‰ 62 äº¿å‚æ•°ã€‚</p>
<p>ç»“åˆæ¨¡å‹é‡åŒ–æŠ€æœ¯ï¼Œç”¨æˆ·å¯ä»¥åœ¨æ¶ˆè´¹çº§çš„æ˜¾å¡ä¸Šè¿›è¡Œæœ¬åœ°éƒ¨ç½²ï¼ˆINT4 é‡åŒ–çº§åˆ«ä¸‹æœ€ä½åªéœ€ 6GB æ˜¾å­˜ï¼‰ã€‚ ChatGLM-6B ä½¿ç”¨äº†å’Œ ChatGPT ç›¸ä¼¼çš„æŠ€æœ¯ï¼Œé’ˆå¯¹ä¸­æ–‡é—®ç­”å’Œå¯¹è¯è¿›è¡Œäº†ä¼˜åŒ–ã€‚ç»è¿‡çº¦ 1T æ ‡è¯†ç¬¦çš„ä¸­è‹±åŒè¯­è®­ç»ƒï¼Œè¾…ä»¥ç›‘ç£å¾®è°ƒã€åé¦ˆè‡ªåŠ©ã€äººç±»åé¦ˆå¼ºåŒ–å­¦ä¹ ç­‰æŠ€æœ¯çš„åŠ æŒï¼Œ62 äº¿å‚æ•°çš„ ChatGLM-6B å·²ç»èƒ½ç”Ÿæˆç›¸å½“ç¬¦åˆäººç±»åå¥½çš„å›ç­”ï¼Œæ›´å¤šä¿¡æ¯è¯·å‚è€ƒä»–ä»¬çš„<a href="https://chatglm.cn/blog">åšå®¢</a>ã€‚æ¬¢è¿é€šè¿‡ <a href="https://chatglm.cn/">chatglm.cn</a> ä½“éªŒæ›´å¤§è§„æ¨¡çš„ ChatGLM æ¨¡å‹ã€‚</p>
<p>ChatGLM-6B æƒé‡å¯¹å­¦æœ¯ç ”ç©¶å®Œå…¨å¼€æ”¾ï¼Œåœ¨å¡«å†™<a href="https://open.bigmodel.cn/mla/form">é—®å·</a>è¿›è¡Œç™»è®°åäº¦å…è®¸å…è´¹å•†ä¸šä½¿ç”¨ã€‚</p>
<h2 id="introduction">æ¦‚è¿°<a class="headerlink" href="#introduction" title="Permanent link">ïƒ</a></h2>
<p>2024 å¹´ 4 æœˆå› å·¥ä½œéœ€è¦å­¦ä¹ éƒ¨ç½²ä¸€ä¸ªæœ¬åœ° ChatGLM ç¯å¢ƒã€‚ä½¿ç”¨çš„ç®—åŠ›æœåŠ¡å™¨ä¸Šåˆ›å»ºçš„è™šæ‹Ÿæœºï¼Œæœºå™¨é…ç½®å¦‚ä¸‹:</p>
<p>| ç±»åˆ« | å‹å· | å¤‡æ³¨ |
| CPU | Intel(R) Xeon(R) Silver 4110 CPU @ 2.10GHz | 16 æ ¸ 32 çº¿ç¨‹ |
| å†…å­˜ | 16G | |
| ç¡¬ç›˜ | SSD 350G | |
| æ˜¾å¡ | NVIDIA GeForce RTX 2080 Ti | æ˜¾å­˜ 11G |
| ç³»ç»Ÿ | Microsoft Windows 10 Pro | 10.0.18363.778 Build 18363.778 |</p>
<p>é¡¹ç›®ä»£ç ä»“åº“: <a href="https://github.com/THUDM/ChatGLM-6B">https://github.com/THUDM/ChatGLM-6B</a></p>
<h2 id="python">Python<a class="headerlink" href="#python" title="Permanent link">ïƒ</a></h2>
<p>ä¸€å¼€å§‹å®‰è£…çš„æœ€æ–°ç‰ˆ Python 3.12ï¼Œä½†æ˜¯ <code>pip install -r requirements.txt</code> å®‰è£…ä¾èµ–æ€»æ˜¯æŠ¥é”™ã€‚è¿˜ä¼šéœ€è¦ Rust ç¼–è¯‘ç¯å¢ƒã€‚åæ¥çœ‹åˆ°ä¸€ç¯‡åšå®¢è¯´æ˜¯ Python ç‰ˆæœ¬å¤ªæ–°å¯èƒ½ä¸æ”¯æŒï¼Œäºæ˜¯æˆ‘å¸è½½é‡æ–°å®‰è£…äº† Python 3.10.10 ç‰ˆæœ¬ï¼Œå†æ¬¡å®‰è£…ä¾èµ–æ—¶ï¼Œå‘½ä»¤ä¸€æ¬¡é€šè¿‡ã€‚</p>
<pre><code class="language-shell">C:\Users\Administrator&gt;python -V
Python 3.10.10

C:\Users\Administrator&gt;pip -V
pip 22.3.1 from C:\Program Files\Python310\lib\site-packages\pip (python 3.10)
</code></pre>
<h2 id="cuda">Cuda<a class="headerlink" href="#cuda" title="Permanent link">ïƒ</a></h2>
<pre><code class="language-shell">C:\Users\Administrator&gt;python
Python 3.10.10 (tags/v3.10.10:aad5f6a, Feb  7 2023, 17:20:36) [MSC v.1929 64 bit (AMD64)] on win32
Type &quot;help&quot;, &quot;copyright&quot;, &quot;credits&quot; or &quot;license&quot; for more information.
&gt;&gt;&gt; import torch # å¦‚æœ PyTorch å®‰è£…æˆåŠŸå³å¯å¯¼å…¥
&gt;&gt;&gt; print(torch.__version__) # torch ç‰ˆæœ¬
2.3.0+cu118
&gt;&gt;&gt; print(torch.cuda.is_available()) # æŸ¥çœ‹ CUDA æ˜¯å¦å¯ç”¨
True
&gt;&gt;&gt; print(torch.cuda.device_count()) # æŸ¥çœ‹å¯ç”¨çš„ CUDA æ•°é‡
1
&gt;&gt;&gt; print(torch.version.cuda) # æŸ¥çœ‹ CUDA çš„ç‰ˆæœ¬å·
11.8
&gt;&gt;&gt;
</code></pre>
<p>ä¸Šé¢æ˜¯æ­£ç¡®å®‰è£…çš„ç»“æœï¼Œä½†æ˜¯æˆ‘çš„ CUDA æ€»æ˜¯ä¸å¯ç”¨ã€‚ä¸‹é¢æ˜¯è¸©å‘è®°å½•ã€‚</p>
<p>ä¸‹è½½ CUDA: <a href="https://developer.nvidia.com/cuda-toolkit-archive">https://developer.nvidia.com/cuda-toolkit-archive</a></p>
<p>ä¸€å¼€å§‹æˆ‘éšä¾¿ä¸‹è½½äº† Cuda 11.6 ç‰ˆæœ¬å®‰è£…äº†ï¼Œåæ¥çœ‹åˆ° PyTorch ä¸Šè¯´ PyTorch è¦å’Œ Cuda çš„ç‰ˆæœ¬è¦å¯¹åº”ï¼Œè€Œä¸” Cuda ç‰ˆæœ¬è¦å°äº <code>nvidia-smi</code> å³ä¸Šè§’çš„ CUDA Versionã€‚äºæ˜¯åˆé‡æ–°ä¸‹è½½å®‰è£…äº† Cuda 11.8 ç‰ˆæœ¬ã€‚</p>
<p><a href="https://pytorch.org/get-started/locally/">PyTorch Get Started</a></p>
<pre><code class="language-shell">C:\Users\Administrator&gt;nvidia-smi
Mon Apr 29 10:28:20 2024
+---------------------------------------------------------------------------------------+
| NVIDIA-SMI 536.23                 Driver Version: 536.23       CUDA Version: 12.2     |
|-----------------------------------------+----------------------+----------------------+
| GPU  Name                     TCC/WDDM  | Bus-Id        Disp.A | Volatile Uncorr. ECC |
| Fan  Temp   Perf          Pwr:Usage/Cap |         Memory-Usage | GPU-Util  Compute M. |
|                                         |                      |               MIG M. |
|=========================================+======================+======================|
|   0  NVIDIA GeForce RTX 2080 Ti   WDDM  | 00000000:05:00.0  On |                  N/A |
| 27%   33C    P8              24W / 250W |    334MiB / 11264MiB |      1%      Default |
|                                         |                      |                  N/A |
+-----------------------------------------+----------------------+----------------------+

+---------------------------------------------------------------------------------------+
| Processes:                                                                            |
|  GPU   GI   CI        PID   Type   Process name                            GPU Memory |
|        ID   ID                                                             Usage      |
|=======================================================================================|
|    0   N/A  N/A      2656    C+G   C:\Windows\explorer.exe                   N/A      |
|    0   N/A  N/A      2888    C+G   ...siveControlPanel\SystemSettings.exe    N/A      |
|    0   N/A  N/A      6116    C+G   ....Experiences.TextInput.InputApp.exe    N/A      |
|    0   N/A  N/A      8648    C+G   ...2txyewy\StartMenuExperienceHost.exe    N/A      |
|    0   N/A  N/A      9024    C+G   ....Cortana_cw5n1h2txyewy\SearchUI.exe    N/A      |
|    0   N/A  N/A      9132    C+G   ..._8wekyb3d8bbwe\Microsoft.Photos.exe    N/A      |
|    0   N/A  N/A      9528    C+G   ...iles (x86)\DeepLink\deeplink_ui.exe    N/A      |
|    0   N/A  N/A     11388    C+G   ...5n1h2txyewy\ShellExperienceHost.exe    N/A      |
|    0   N/A  N/A     12904    C+G   ...cal\Microsoft\OneDrive\OneDrive.exe    N/A      |
|    0   N/A  N/A     15044    C+G   ...crosoft\Edge\Application\msedge.exe    N/A      |
+---------------------------------------------------------------------------------------+

C:\Users\Administrator&gt;
C:\Users\Administrator&gt;nvcc -V
nvcc: NVIDIA (R) Cuda compiler driver
Copyright (c) 2005-2022 NVIDIA Corporation
Built on Wed_Sep_21_10:41:10_Pacific_Daylight_Time_2022
Cuda compilation tools, release 11.8, V11.8.89
Build cuda_11.8.r11.8/compiler.31833905_0
</code></pre>
<p>ç‰ˆæœ¬éƒ½å¯¹åº”åå†æ¬¡å°è¯•ï¼Œè¿˜æ˜¯ä¸è¡Œï¼Œé—®äº† ChatGPTï¼Œç„¶åå‘ç° PyTorch æœ‰å¸¦ cuda å’Œä¸å¸¦ä¸¤ç§ç‰ˆæœ¬å·ï¼Œåªèƒ½å¸è½½äº†é‡æ–°å®‰è£…ã€‚</p>
<pre><code class="language-shell">C:\Users\Administrator&gt; pip list
Package                   Version
------------------------- -----------
...
torch                     2.3.0
torchaudio                2.3.0
...
C:\Users\Administrator&gt;
C:\Users\Administrator&gt; pip uninstall torch torchvision torchaudio
C:\Users\Administrator&gt; pip install torch torchvision torchaudio --index-url https://download.pytorch.org/whl/cu118
C:\Users\Administrator&gt;
C:\Users\Administrator&gt; pip list
Package                   Version
------------------------- -----------
...
torch                     2.3.0+cu118
torchaudio                2.3.0+cu118
...
C:\Users\Administrator&gt;
</code></pre>
<p>ä¸€ç•ªæ“ä½œä¹‹åï¼ŒCUDA ç»ˆäºå¯ç”¨äº†ã€‚</p>
<h2 id="test">æµ‹è¯•<a class="headerlink" href="#test" title="Permanent link">ïƒ</a></h2>
<p>æµ‹è¯•ä»£ç  <code>test.py</code> å†…å®¹å¦‚ä¸‹:</p>
<pre><code class="language-python">from transformers import AutoTokenizer, AutoModel

# tokenizer = AutoTokenizer.from_pretrained(&quot;THUDM/chatglm-6b&quot;, trust_remote_code=True)
# model = AutoModel.from_pretrained(&quot;THUDM/chatglm-6b&quot;, trust_remote_code=True).half().cuda()
# æ ¹æ® torch.cuda.is_available() åˆ¤æ–­ï¼Œå¦‚æœä¸º Falseï¼Œåˆ™ä½¿ç”¨ CPU åšæµ®ç‚¹è¿ç®—
# model = AutoModel.from_pretrained(&quot;THUDM/chatglm-6b&quot;, trust_remote_code=True).half().float()
# ä½¿ç”¨ç¦»çº¿ä¸‹è½½çš„æœ¬åœ°æ¨¡å‹å‚æ•°æ–‡ä»¶
tokenizer = AutoTokenizer.from_pretrained(&quot;C:\\Users\\Administrator\\Documents\\Code\\ChatGLM-6B\\THUDM\\chatglm2-6b-int4&quot;, trust_remote_code=True, revision=&quot;v1.1.0&quot;)
model = AutoModel.from_pretrained(&quot;C:\\Users\\Administrator\\Documents\\Code\\ChatGLM-6B\\THUDM\\chatglm2-6b-int4&quot;, trust_remote_code=True, revision=&quot;v1.1.0&quot;).half().cuda()
model = model.eval()
response, history = model.chat(tokenizer, &quot;ä½ å¥½&quot;, history=[])
print(response)
# ä½ å¥½ğŸ‘‹!æˆ‘æ˜¯äººå·¥æ™ºèƒ½åŠ©æ‰‹ ChatGLM-6B,å¾ˆé«˜å…´è§åˆ°ä½ ,æ¬¢è¿é—®æˆ‘ä»»ä½•é—®é¢˜ã€‚
response, history = model.chat(tokenizer, &quot;æ™šä¸Šç¡ä¸ç€åº”è¯¥æ€ä¹ˆåŠ&quot;, history=history)
print(response)
# æ™šä¸Šç¡ä¸ç€å¯èƒ½ä¼šè®©ä½ æ„Ÿåˆ°ç„¦è™‘æˆ–ä¸èˆ’æœ,ä½†ä»¥ä¸‹æ˜¯ä¸€äº›å¯ä»¥å¸®åŠ©ä½ å…¥ç¡çš„æ–¹æ³•:
# 
# 1. åˆ¶å®šè§„å¾‹çš„ç¡çœ æ—¶é—´è¡¨:ä¿æŒè§„å¾‹çš„ç¡çœ æ—¶é—´è¡¨å¯ä»¥å¸®åŠ©ä½ å»ºç«‹å¥åº·çš„ç¡çœ ä¹ æƒ¯,ä½¿ä½ æ›´å®¹æ˜“å…¥ç¡ã€‚å°½é‡åœ¨æ¯å¤©çš„ç›¸åŒæ—¶é—´ä¸ŠåºŠ,å¹¶åœ¨åŒä¸€æ—¶é—´èµ·åºŠã€‚
# 2. åˆ›é€ ä¸€ä¸ªèˆ’é€‚çš„ç¡çœ ç¯å¢ƒ:ç¡®ä¿ç¡çœ ç¯å¢ƒèˆ’é€‚,å®‰é™,é»‘æš—ä¸”æ¸©åº¦é€‚å®œã€‚å¯ä»¥ä½¿ç”¨èˆ’é€‚çš„åºŠä¸Šç”¨å“,å¹¶ä¿æŒæˆ¿é—´é€šé£ã€‚
# 3. æ”¾æ¾èº«å¿ƒ:åœ¨ç¡å‰åšäº›æ”¾æ¾çš„æ´»åŠ¨,ä¾‹å¦‚æ³¡ä¸ªçƒ­æ°´æ¾¡,å¬äº›è½»æŸ”çš„éŸ³ä¹,é˜…è¯»ä¸€äº›æœ‰è¶£çš„ä¹¦ç±ç­‰,æœ‰åŠ©äºç¼“è§£ç´§å¼ å’Œç„¦è™‘,ä½¿ä½ æ›´å®¹æ˜“å…¥ç¡ã€‚
# 4. é¿å…é¥®ç”¨å«æœ‰å’–å•¡å› çš„é¥®æ–™:å’–å•¡å› æ˜¯ä¸€ç§åˆºæ¿€æ€§ç‰©è´¨,ä¼šå½±å“ä½ çš„ç¡çœ è´¨é‡ã€‚å°½é‡é¿å…åœ¨ç¡å‰é¥®ç”¨å«æœ‰å’–å•¡å› çš„é¥®æ–™,ä¾‹å¦‚å’–å•¡,èŒ¶å’Œå¯ä¹ã€‚
# 5. é¿å…åœ¨åºŠä¸Šåšä¸ç¡çœ æ— å…³çš„äº‹æƒ…:åœ¨åºŠä¸Šåšäº›ä¸ç¡çœ æ— å…³çš„äº‹æƒ…,ä¾‹å¦‚çœ‹ç”µå½±,ç©æ¸¸æˆæˆ–å·¥ä½œç­‰,å¯èƒ½ä¼šå¹²æ‰°ä½ çš„ç¡çœ ã€‚
# 6. å°è¯•å‘¼å¸æŠ€å·§:æ·±å‘¼å¸æ˜¯ä¸€ç§æ”¾æ¾æŠ€å·§,å¯ä»¥å¸®åŠ©ä½ ç¼“è§£ç´§å¼ å’Œç„¦è™‘,ä½¿ä½ æ›´å®¹æ˜“å…¥ç¡ã€‚è¯•ç€æ…¢æ…¢å¸æ°”,ä¿æŒå‡ ç§’é’Ÿ,ç„¶åç¼“æ…¢å‘¼æ°”ã€‚
# 
# å¦‚æœè¿™äº›æ–¹æ³•æ— æ³•å¸®åŠ©ä½ å…¥ç¡,ä½ å¯ä»¥è€ƒè™‘å’¨è¯¢åŒ»ç”Ÿæˆ–ç¡çœ ä¸“å®¶,å¯»æ±‚è¿›ä¸€æ­¥çš„å»ºè®®ã€‚
</code></pre>
<p>å½“æˆ‘ä»¬ä½¿ç”¨é¡¹ç›®ä»£ç é»˜è®¤çš„æ–¹å¼æ—¶ï¼Œä¼šè‡ªåŠ¨ä¸‹è½½å¥½å‡ ä¸ª GB çš„æ¨¡å‹å‚æ•°æ–‡ä»¶ã€‚æ¨èæ‰‹åŠ¨ä¸‹è½½æ¨¡å‹å‚æ•°æ–‡ä»¶ï¼Œå¹¶ä½¿ç”¨ä¸Šé¢çš„ä»£ç æŒ‡å®šä¸‹è½½åçš„è·¯å¾„ï¼Œå³å¯ä»æœ¬åœ°åŠ è½½æ¨¡å‹ã€‚</p>
<pre><code class="language-shell">C:\Users\Administrator\Documents\Code\ChatGLM-6B&gt;python test.py
Load parallel cpu kernel failed C:\Users\Administrator\.cache\huggingface\modules\transformers_modules\chatglm2-6b-int4\quantization_kernels_parallel.so: Traceback (most recent call last):
  File &quot;C:\Users\Administrator/.cache\huggingface\modules\transformers_modules\chatglm2-6b-int4\quantization.py&quot;, line 148, in __init__
    kernels = ctypes.cdll.LoadLibrary(kernel_file)
  File &quot;C:\Program Files\Python310\lib\ctypes\__init__.py&quot;, line 452, in LoadLibrary
    return self._dlltype(name)
  File &quot;C:\Program Files\Python310\lib\ctypes\__init__.py&quot;, line 374, in __init__
    self._handle = _dlopen(self._name, mode)
FileNotFoundError: Could not find module 'C:\Users\Administrator\.cache\huggingface\modules\transformers_modules\chatglm2-6b-int4\quantization_kernels_parallel.so' (or one of its dependencies). Try using the full path with constructor syntax.

C:\Users\Administrator/.cache\huggingface\modules\transformers_modules\chatglm2-6b-int4\modeling_chatglm.py:226: UserWarning: 1Torch was not compiled with flash attention. (Triggered internally at ..\aten\src\ATen\native\transformers\cuda\sdp_utils.cpp:455.)
  context_layer = torch.nn.functional.scaled_dot_product_attention(query_layer, key_layer, value_layer,
ä½ å¥½ğŸ‘‹ï¼æˆ‘æ˜¯äººå·¥æ™ºèƒ½åŠ©æ‰‹ ChatGLM2-6Bï¼Œå¾ˆé«˜å…´è§åˆ°ä½ ï¼Œæ¬¢è¿é—®æˆ‘ä»»ä½•é—®é¢˜ã€‚
æŠ±æ­‰ï¼Œæˆ‘æ˜¯ä¸€ä¸ªäººå·¥æ™ºèƒ½åŠ©æ‰‹ï¼Œæ— æ³•äº†è§£ä½ çš„å…·ä½“æƒ…å†µï¼Œä½†æ˜¯æˆ‘å¯ä»¥æä¾›ä¸€äº›é€šç”¨çš„å»ºè®®æ¥å¸®åŠ©ä½ æ”¹å–„ç¡çœ è´¨é‡ã€‚

1. æ”¹å–„ç¡çœ ç¯å¢ƒï¼šç¡®ä¿ç¡çœ ç¯å¢ƒå®‰é™ã€èˆ’é€‚ã€é»‘æš—ã€å‡‰çˆ½ã€‚

2. åˆ›é€ æœ‰ç›Šçš„ç¡å‰ä¹ æƒ¯ï¼šæ¯å¤©å›ºå®šçš„ç¡çœ æ—¶é—´ã€è§„å¾‹çš„ç”Ÿæ´»ä½œæ¯ã€å‡å°‘æœ‰å®³ç‰©å“ï¼ˆå¦‚å’–å•¡å› ã€å°¼å¤ä¸ã€é…’ç²¾ç­‰ï¼‰çš„æ‘„å…¥ã€‚

3. æ”¾æ¾èº«å¿ƒï¼šä½¿ç”¨è½»æ¾çš„æ´»åŠ¨å’Œå¨±ä¹æ–¹å¼æ¥ç¼“è§£å‹åŠ›å’Œç„¦è™‘ã€‚

4. é™åˆ¶èººåœ¨åºŠä¸Šçš„æ—¶é—´ï¼šå¦‚æœåœ¨åºŠä¸Šèººäº†30åˆ†é’Ÿè¿˜æœªå…¥ç¡ï¼Œä¸è¦ç»§ç»­èººåœ¨åºŠä¸Šï¼Œè€Œæ˜¯èµ·åºŠåšäº›è½»æ¾çš„æ´»åŠ¨ï¼Œç›´åˆ°æ„Ÿåˆ°å›°å€¦å†è¿”å›åºŠä¸Šã€‚

5. é”»ç‚¼èº«ä½“ï¼šé€‚åº¦çš„èº«ä½“è¿åŠ¨å¯ä»¥å¸®åŠ©èº«ä½“æ”¾æ¾å’Œç–²åŠ³ï¼Œæœ‰åŠ©äºç¡çœ ã€‚

å¦‚æœè¿™äº›æ–¹æ³•ä»ç„¶æ— æ³•å¸®åŠ©ä½ æ”¹å–„ç¡çœ è´¨é‡ï¼Œè¯·å¯»æ±‚åŒ»ç”Ÿçš„å»ºè®®ã€‚

C:\Users\Administrator\Documents\Code\ChatGLM-6B&gt;
</code></pre>
<p>å…¶å®å½“ CUDA ä¸å¯ç”¨æ—¶ï¼Œè¿˜å¯ä»¥ä½¿ç”¨ CPU è¿›è¡Œæ¨ç†ï¼Œä½†æ˜¯æ¨ç†é€Ÿåº¦ä¼šæ›´æ…¢ï¼Œè€Œä¸”ä¼šæŠŠå†…å­˜å æ»¡(éœ€è¦å¤§æ¦‚ 32GB å†…å­˜ï¼Œè€Œæœ¬æœºåªæœ‰ 16GB)ã€‚</p>
<h2 id="package">æ‰“åŒ…<a class="headerlink" href="#package" title="Permanent link">ïƒ</a></h2>
<p>æ¨¡å‹ç®€å•è°ƒç”¨ä»£ç  <code>app.py</code> ä»£ç å¦‚ä¸‹:</p>
<pre><code class="language-python">import argparse
import os
import torch
from transformers import AutoTokenizer, AutoModel

parser = argparse.ArgumentParser(description=&quot;Command Line for ChatGLM-6B&quot;)
parser.add_argument(&quot;--prompt&quot;, &quot;-P&quot;, help=&quot;prompt word for model&quot;, default=&quot;ä½ å¥½&quot;)
parser.add_argument(&quot;--model&quot;, &quot;-m&quot;, help=&quot;local model parameter file path&quot;)
args = parser.parse_args()

script_path = os.path.abspath(__file__)
print(script_path)

script_dir = os.path.dirname(os.path.realpath(__file__))
print(script_dir)

print(torch.cuda.is_available())

if __name__ == '__main__':
    local_model = os.path.join(script_dir, &quot;THUDM&quot;, &quot;chatglm2-6b-int4&quot;)
    if args.model is not None:
        local_model = args.model
    tokenizer = AutoTokenizer.from_pretrained(local_model, trust_remote_code=True)
    model = AutoModel.from_pretrained(local_model, trust_remote_code=True).half()
    if torch.cuda.is_available():
        model = model.cuda()
    else:
        model = model.float()
    model = model.eval()
    response, history = model.chat(tokenizer, args.prompt, history=[])
    print(response)
</code></pre>
<p>ä¸€èˆ¬é¡¹ç›®ï¼Œæ€»ä¼šæ‰“åŒ…æˆå¯æ‰§è¡Œç¨‹åºï¼Œæ–¹ä¾¿å®¢æˆ·éƒ¨ç½²ã€‚æ‰€ä»¥æˆ‘ä»¥ä¸ºè¿™ä¸ªå¤§è¯­è¨€æ¨¡å‹ï¼Œä¹Ÿå¯ä»¥æ‰“åŒ…æˆå•ç‹¬çš„å¯æ‰§è¡Œç¨‹åºï¼Œå†åŠ¨æ€åŠ è½½æ¨¡å‹å‚æ•°æ–‡ä»¶ã€‚</p>
<p>å¯æ˜¯å®é™…ç»“æœä»¤äººåƒæƒŠï¼Œä½¿ç”¨ <code>pyinstaller -F -n app app.py</code> æ‰“åŒ…åçš„ç¨‹åºæ–‡ä»¶å¤§å°é«˜è¾¾ 2.67 GBï¼Œè¿è¡Œé€Ÿåº¦è¶…æ…¢ï¼Œå¤§æ¦‚æ˜¯å› ä¸ºç¨‹åºåŠ è½½å™¨åœ¨åŠ è½½è¶…å¤§æ–‡ä»¶åº”ç”¨æ—¶å—ç£ç›˜å’Œå†…å­˜è¯»å†™é€Ÿåº¦é™åˆ¶ï¼Œè¿™è¡¨ç°è¿˜ä¸å¦‚ç›´æ¥ç”¨å‘½ä»¤ <code>python app.py</code> æ‰§è¡Œè„šæœ¬é€Ÿåº¦å¿«å‘¢ã€‚</p>
<p>äºæ˜¯æˆ‘æƒ³ç€ä½¿ç”¨ <a href="https://github.com/upx/upx">Upx</a> å‹ç¼©èƒ½å¦å‡å°ä½“ç§¯ï¼Œä¸‹è½½ Upx å¹¶è§£å‹ï¼Œç„¶åä½¿ç”¨å‘½ä»¤ <code>pyinstaller -F -n app --upx-dir C:\Users\Administrator\Documents\upx-4.2.3-win64 app.py</code> å†æ¬¡æ‰“åŒ…ï¼Œç¨‹åºæ–‡ä»¶å¤§å°ä¸º 2.39 GBï¼Œæœ‰æ•ˆæœä½†ä½œç”¨ä¸å¤§ï¼Œæ²¡æœ‰è¾¾åˆ°ç™¾å…†å¤§å°ï¼Œæ²¡æœ‰å®é™…æ„ä¹‰ã€‚</p>
<p>åé¢æˆ‘è¯•ç€ä¸æ‰“åŒ…ä¸€ä¸ªç‹¬ç«‹æ–‡ä»¶ï¼Œä½¿ç”¨å‘½ä»¤ <code>pyinstaller -n app app.py</code> æ‰“åŒ…ï¼Œç„¶åå‘ç° app.exe åªæœ‰ 35.6 MBï¼Œä½†æ˜¯ä¾èµ–åŒ…è¶³è¶³ 4.76 GBï¼Œå•å• <code>torch_cuda.dll</code> ä¸€ä¸ªæ–‡ä»¶å°±æœ‰ 1.10 GBã€‚è¿™å½»åº•æ‰“æ¶ˆäº†æˆ‘çš„æ‰“åŒ…éƒ¨ç½²æƒ³æ³•ï¼Œæˆ‘ç»ˆäºæ˜ç™½é‚£äº›çŸ¥åå¤§æ¨¡å‹ä¸ºä»€ä¹ˆä¼šä½¿ç”¨ Docker æ¥éƒ¨ç½²äº†ã€‚å› ä¸ºå³ä¾¿ Docker å®‰è£…ä½¿ç”¨å¾ˆéº»çƒ¦ï¼Œä½†å®ƒèƒ½å¤Ÿç”¨ç®€å•çš„æ“ä½œå’Œå‘½ä»¤æ¥å®Œæ•´çš„éƒ¨ç½²å¦‚æ­¤å¤æ‚å’Œåºå¤§çš„æ¨¡å‹ç¯å¢ƒï¼Œè¿™å°±è¶³å¤Ÿäº†ã€‚</p>
<h2 id="references">å‚è€ƒèµ„æ–™<a class="headerlink" href="#references" title="Permanent link">ïƒ</a></h2>
<p><a href="https://juejin.cn/post/7245682364932669496">chatglmåœ¨windowsä¸Šç§æœ‰åŒ–éƒ¨ç½² | é›¶åŸºç¡€å°ç™½çˆ¬å‘</a></p></div>
            </div>
        </div>

        <footer class="col-md-12">
            <hr>
                <p>Copyright &copy; 2022 Jerry, All Rights Reserved.</p>
            <p>Documentation built with <a href="https://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>
        <script src="../../js/bootstrap.bundle.min.js"></script>
        <script>
            var base_url = "../..",
                shortcuts = {"help": 191, "next": 78, "previous": 80, "search": 83};
        </script>
        <script src="../../js/base.js"></script>
        <script src="../../search/main.js"></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="searchModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="searchModalLabel">Search</h4>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>From here you can search these documents. Enter your search terms below.</p>
                <form>
                    <div class="form-group">
                        <input type="search" class="form-control" placeholder="Search..." id="mkdocs-search-query" title="Type search term here">
                    </div>
                </form>
                <div id="mkdocs-search-results" data-no-results-text="No results found"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div><div class="modal" id="mkdocs_keyboard_modal" tabindex="-1" role="dialog" aria-labelledby="keyboardModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="keyboardModalLabel">Keyboard Shortcuts</h4>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width: 20%;">Keys</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="help shortcut"><kbd>?</kbd></td>
                    <td>Open this help</td>
                  </tr>
                  <tr>
                    <td class="next shortcut"><kbd>n</kbd></td>
                    <td>Next page</td>
                  </tr>
                  <tr>
                    <td class="prev shortcut"><kbd>p</kbd></td>
                    <td>Previous page</td>
                  </tr>
                  <tr>
                    <td class="search shortcut"><kbd>s</kbd></td>
                    <td>Search</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>

    </body>
</html>
